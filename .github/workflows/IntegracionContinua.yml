- name: Ejecutar pruebas y capturar salida
  run: |
    pytest > result.log || true

- name: Leer salida de pruebas
  id: leer_salida
  run: |
    echo 'resultado<<EOF' >> $GITHUB_OUTPUT
    tail -n 20 result.log >> $GITHUB_OUTPUT
    echo 'EOF' >> $GITHUB_OUTPUT

- name: Notificar a Slack
  if: always()
  uses: slackapi/slack-github-action@v1.23.0
  with:
    payload: |
      {
        "blocks": [
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "*Estado del build:* ${{ job.status }}\n*Repositorio:* ${{ github.repository }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref }}"
            }
          },
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "*Resumen de pruebas:*\n```${{ steps.leer_salida.outputs.resultado }}```"
            }
          }
        ]
      }
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

